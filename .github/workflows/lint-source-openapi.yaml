name: Lint source specification

on:
  pull_request:
    branches:
      - "release/*"
      - "main"
  workflow_dispatch:

# This workflow only reads repository contents and PR metadata.
# It does not commit, tag, publish, or modify anything.
permissions:
  contents: read
  pull-requests: read

jobs:
  lint-source-specification:
    runs-on: ubuntu-latest

    steps:
      # Check out the repository so the runner has access to:
      # - source/spec.yaml
      # - .openapi/lint.yaml
      #
      # fetch-depth: 0 avoids edge cases with PRs that include merge commits
      # or cherry-picks, even though this job is read-only.
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # If source/ does not exist but v5/ does, this is a valid legacy layout.
      # In that case we skip linting successfully.
      - name: Check source layout
        run: |
          if [ ! -d "source" ] && [ -d "v5" ]; then
            echo "source/ not present, v5/ detected, skipping lint"
            exit 0
          fi

          if [ ! -d "source" ]; then
            echo "::error::source/ directory not found."
            exit 1
          fi

      # Install the OpenAPI CLI using Go (always latest).
      - name: Install openapi CLI
        run: |
          go install github.com/speakeasy-api/openapi/cmd/openapi@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      # Run the OpenAPI linter using the repo config.
      - name: Lint OpenAPI specification
        run: |
          openapi spec lint source/spec.yaml -c .openapi/lint.yaml
